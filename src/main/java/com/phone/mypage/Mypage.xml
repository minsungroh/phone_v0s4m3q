<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.phone.mypage.MypageMapperInter">
  <insert id="create" parameterType="MypageVO">
    insert into mypage(orderstate, ordersubmit, point, payno, mno)
    values(#{orderstate}, 'N', 0, #{payno}, #{mno});
  </insert>

  <select id="read" resultType="MypageVO" parameterType="MypageVO">
    select mypageno, orderstate, ordersubmit, point, payno, mno
    from mypage
    where mno=#{mno}
  </select>
  
  <select id="count_paywait" resultType="int" parameterType="int">
    select count(m.mypageno) as cnt
    from mypage m
    join payment p on m.payno = p.payno 
    where m.my_state='결제대기중' and m.mno=#{mno}
    and date(p.payday) &gt;= date(subdate(now(), INTERVAL 30 DAY)) 
    and date(p.payday) &lt;= date(now())
  </select>
  
  <select id="count_payok" resultType="int" parameterType="int">
    select count(m.mypageno) as cnt
    from mypage m
    join payment p on m.payno = p.payno 
    where m.my_state='결제완료' and m.mno=#{mno}
    and date(p.payday) &gt;= date(subdate(now(), INTERVAL 30 DAY)) 
    and date(p.payday) &lt;= date(now())
  </select>
  
  <select id="count_pready" resultType="int" parameterType="int">
    select count(m.mypageno) as cnt
    from mypage m
    join payment p on m.payno = p.payno 
    where m.my_state='상품준비중' and m.mno=#{mno}
    and date(p.payday) &gt;= date(subdate(now(), INTERVAL 30 DAY)) 
    and date(p.payday) &lt;= date(now())
  </select>
  
  <select id="count_delivery" resultType="int" parameterType="int">
    select count(m.mypageno) as cnt
    from mypage m
    join payment p on m.payno = p.payno 
    where m.my_state='배송중' and m.mno=#{mno}
    and date(p.payday) &gt;= date(subdate(now(), INTERVAL 30 DAY)) 
    and date(p.payday) &lt;= date(now())
  </select>
  
   <select id="count_complate" resultType="int" parameterType="int">
    select count(m.mypageno) as cnt
    from mypage m
    join payment p on m.payno = p.payno 
    where m.my_state='배송완료' and m.mno=#{mno}
    and date(p.payday) &gt;= date(subdate(now(), INTERVAL 30 DAY)) 
    and date(p.payday) &lt;= date(now())
  </select>
  
   <select id="count_okwait" resultType="int" parameterType="int">
    select count(m.mypageno) as cnt
    from mypage m
    join payment p on m.payno = p.payno 
    where m.my_state='구매 결정 대기' and m.mno=#{mno}
    and date(p.payday) &gt;= date(subdate(now(), INTERVAL 30 DAY)) 
    and date(p.payday) &lt;= date(now())
  </select>
  
  <select id="list" resultType="MypageVO" parameterType="MypageVO">
    select m.mypageno, p.item, p.payfile1, p.pcnt, p.paymoney, p.payday, p.orderno, m.orderstate, m.mno, m.ordersubmit, p.paycharge, m.payno, m.point, m.my_state,
    t.waybil, t.waybil2, t.trace_state
    from mypage as m
    join payment as p on m.payno = p.payno
    join trace as t on m.mypageno = t.mypageno
    where m.mno=#{mno}
    and date(p.payday) &gt;= date(subdate(now(), INTERVAL 30 DAY)) 
    and date(p.payday) &lt;= date(now())
  </select>
  
  <select id="detail_read" resultType="MypageVO" parameterType="MypageVO">
    select p.item, p.payfile1, p.pcnt, p.paymoney, p.payday, p.orderno, m.orderstate, t.traceno, t.waybil, p.resive_name, 
    p.resive_phone, p.resive_post, p.resive_addr1, p.resive_addr2, p.paymeans, p.card_input, p.discount, p.deposit_input, p.phone_input, p.paymoney, p.paymeans,
    m.orderstate, m.ordersubmit, m.point, m.payno, m.mno, m.my_state, t.waybil2, t.payno
    from mypage m
    join payment p on m.payno = p.payno
    join trace t on m.mypageno = t.mypageno
    where m.mno=#{mno} and t.waybil=#{waybil}
  </select>
  
  <update id="update_os" parameterType="MypageVO">
      update mypage as m join payment as p on m.payno = p.payno
      set m.ordersubmit=#{ordersubmit}, m.point=#{point}
      where m.mno = #{mno}
  </update>
  
  <select id="update_read" resultType="MypageVO" parameterType="MypageVO">
    select m.mypageno, m.orderstate, m.ordersubmit, m.point, m.payno, m.mno, p.paycharge, p.paymoney
    from mypage as m
    join payment as p on m.payno = p.payno
    join trace as t on m.mypageno = t.mypageno
    where m.mno=#{mno} and t.waybil=#{waybil}
  </select>
   
  <update id="my_state_update" parameterType="MypageVO">
    update mypage
    set my_state=#{my_state}
    where mno=#{mno}
  </update>
</mapper>